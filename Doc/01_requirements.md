# 要件定義（確定版）v1.0  
GAS × スプレッドシート Web予約システム（自動車整備工場向け）

---

## 1. 背景・目的

### 1.1 背景
自動車整備工場において、車検・点検の予約を電話中心で受け付けており、営業時間内の対応負荷・聞き間違い・転記ミス等の課題がある。  
そこで、一般ユーザーがPC/スマホから予約できるWeb予約システムを、Google Apps Script（GAS）とスプレッドシートを中心に構築する。

### 1.2 目的
- 24時間予約受付を可能にし、電話対応負荷を軽減する
- 予約情報をスプレッドシートで一元管理し、運用を単純化する
- 予約をGoogleカレンダーへ連携し、現場の予定共有を容易にする

### 1.3 ゴール（成果物）
- 一般ユーザー向け **Web予約フォーム（GAS Web Apps）**
- 管理者向け **予約管理用スプレッドシート（予約台帳）**
- Googleカレンダー連携（予約作成時にイベント作成）
- 管理者通知（メール）
- 例外処理・ログ（エラー原因が追えること）

---

## 2. スコープ

### 2.1 対象範囲（In Scope）
- 予約作成（即時確定）
- 空き枠判定（枠数：同時刻に受付可能な台数）
- 予約台帳への登録
- Googleカレンダーイベント作成（予約作成時）
- 管理者へのメール通知（新規予約時）
- 管理者によるキャンセル（台帳更新＋カレンダー反映）
- エラーハンドリング（例外ログ、必要時の管理者通知）

### 2.2 対象外（Out of Scope）
- ユーザー認証／会員機能
- ユーザーによるキャンセル機能（管理者対応のみ）
- 決済機能
- 複数店舗対応
- 担当者指名・設備別割当などの高度なリソース管理

---

## 3. 利用者・前提

### 3.1 利用者
- 一般ユーザー（予約者）：PC/スマホで予約フォームを利用
- 管理者（整備工場スタッフ）：スプレッドシートで予約状況を管理

### 3.2 前提
- Web予約フォームは公開URL（認証なし）
- 管理用スプレッドシートは編集権限を限定
- タイムゾーンは `Asia/Tokyo`

---

## 4. 業務要件

### 4.1 予約メニュー
- 車検
- 点検  
※将来的なメニュー追加を想定

### 4.2 予約単位
- 予約枠は **日時固定（例：2026/01/24 10:00）**
- 同一日時に対して **枠数（capacity）** を持つ  
  - capacity = 同時刻に受付できる台数

### 4.3 所要時間（メニュー別）
- 車検：〇分
- 点検：〇分  
※Googleカレンダーの終了時刻算出に使用

### 4.4 キャンセル運用
- ユーザーキャンセルは不可
- 管理者が予約台帳でキャンセル操作を行う

---

## 5. 業務フロー要件

### 5.1 予約作成（即時確定）
1. ユーザーが予約フォームから送信
2. 入力チェック（必須・形式）
3. 排他制御（同時予約防止）
4. 空き枠判定（有効予約数 < capacity）
5. 予約台帳に `CONFIRMED` で登録
6. Googleカレンダーにイベント作成
7. 台帳に `calendar_event_id` を保存
8. 管理者へ通知メール送信
9. 完了画面表示

### 5.2 満枠時
- 台帳登録・カレンダー作成は行わない
- ユーザーに満枠メッセージを表示

### 5.3 管理者キャンセル
- 台帳を `CANCELED` に更新
- 紐づくカレンダーイベントを削除（またはキャンセル表記）

---

## 6. 機能要件

### 6.1 Web予約フォーム（一般ユーザー）

#### 必須入力
- 予約メニュー
- 予約日時
- 氏名
- 電話番号

#### 任意入力
- メールアドレス
- 備考
- 車両情報

#### バリデーション
- 必須未入力チェック
- 電話番号形式チェック
- 満枠チェック

#### 結果表示
- 成功：予約ID・日時を表示
- 失敗：エラー内容を表示

---

### 6.2 予約台帳（管理者）

#### ステータス
- `CONFIRMED`
- `CANCELED`
- `ERROR`（例外時）

#### 管理操作
- 予約一覧の閲覧
- キャンセル操作（ステータス更新）

---

### 6.3 Googleカレンダー連携
- 予約作成時にイベント作成
- 開始：予約日時
- 終了：開始＋メニュー別所要時間
- イベントIDを台帳に保存

---

### 6.4 管理者通知（メール）
- 新規予約確定時に送信
- 内容：日時、メニュー、氏名、電話番号、予約ID 等

---

### 6.5 排他制御
- 同時アクセス時も `capacity` を超えないこと
- GASのロック機構を使用

---

### 6.6 エラーハンドリング
- 例外時にログを記録
- 台帳登録後に失敗した場合は `ERROR` 状態を残す
- 必要に応じて管理者へ通知

---

## 7. データ要件

### 7.1 予約台帳
- reservation_id
- status
- menu
- start_at
- end_at
- name
- tel
- email
- note
- calendar_event_id
- created_at
- updated_at

### 7.2 設定データ（推奨）
- capacity
- menu_duration
- calendar_id
- notify_mail_to

---

## 8. 非機能要件

### 8.1 セキュリティ
- 管理シートは権限管理を行う
- 個人情報の閲覧範囲を制御

### 8.2 性能
- 予約処理は数秒以内
- 排他制御により整合性を確保

### 8.3 運用性
- 枠数・所要時間・通知先はシートで変更可能

---

## 9. 受入条件
- Webから予約でき、台帳に `CONFIRMED` が記録される
- `capacity` を超える予約は作成されない
- カレンダーイベントが作成・紐付けされる
- 管理者に通知メールが届く
- 管理者キャンセルで台帳・カレンダーが整合する
- 例外発生時にログが残る

---

## 10. 今後の検討事項
- 予約枠（capacity）の管理方式
- 営業時間・休業日の扱い
- 空き枠提示方法（事前取得 or 送信時判定）
- ERROR状態の復旧手順
- 予約者への確認メール送信有無
 