# 要件定義（改訂版）v1.1  
GAS × スプレッドシート Web予約システム（自動車整備工場向け）

---

## 1. 背景・目的

### 1.1 背景
自動車整備工場において、車検・点検の予約は電話が主流であるが、
営業時間内の対応負荷、聞き間違い、転記ミス等の課題がある。

一方で、Web予約のみとすると電話予約を希望する一定数の顧客が離脱する
可能性があるため、**Web予約と電話予約の両立** を前提とした
予約管理システムが求められている。

### 1.2 目的
- Web予約により電話対応負荷を軽減する
- 電話予約を排除せず、既存顧客の利便性を維持する
- 予約情報を一元管理し、Web／電話の混在による事故を防ぐ
- Googleカレンダーと連携し、現場の予定共有を容易にする

### 1.3 ゴール（成果物）
- 一般ユーザー向け Web予約フォーム（GAS Web Apps）
- 管理者向け 予約管理用スプレッドシート（予約台帳）
- 管理者向け 電話予約登録機能
- Googleカレンダー連携（予約作成時にイベント作成）
- 管理者通知（メール）
- 例外処理・ログ（障害時に原因が追えること）

---

## 2. 基本方針（Web予約と電話予約の共存）

- **予約台帳（スプレッドシート）を唯一の正（Single Source of Truth）とする**
- Web予約・電話予約ともに、必ず予約台帳を経由して登録する
- Googleカレンダーは予約台帳の内容を反映した結果として扱う
- 電話予約をカレンダーへ直接入力する運用は行わない

---

## 3. スコープ

### 3.1 対象範囲（In Scope）
- Web予約による予約作成（即時確定）
- 電話予約（管理者入力）による予約作成
- 空き枠判定（枠数：同時刻に受付可能な台数）
- 予約台帳への登録・更新
- Googleカレンダーイベント作成（予約作成時）
- 管理者へのメール通知（新規予約時）
- 管理者によるキャンセル
- エラーハンドリング（例外ログ、管理者通知）

### 3.2 対象外（Out of Scope）
- ユーザー認証／会員機能
- ユーザー自身によるキャンセル機能
- 決済機能
- 複数店舗対応
- 電話の自動音声応答（IVR）、CTI連携

---

## 4. 利用者・前提

### 4.1 利用者
- 一般ユーザー（予約者）：Web予約フォームを利用
- 管理者（整備工場スタッフ）：
  - 予約台帳の閲覧・更新
  - 電話予約の登録
  - キャンセル対応

### 4.2 前提
- Web予約フォームは公開URL（認証なし）
- 管理者機能は権限管理された環境でのみ利用
- タイムゾーンは `Asia/Tokyo`

---

## 5. 業務要件

### 5.1 予約メニュー
- 車検
- 点検  
※将来的なメニュー追加を想定

### 5.2 予約単位
- 予約枠は **日時固定（例：2026/01/24 10:00）**
- 同一日時に対して **枠数（capacity）** を持つ  
  - capacity = 同時刻に受付できる台数

### 5.3 所要時間（メニュー別）
- 車検：〇分
- 点検：〇分  
※Googleカレンダーイベントの終了時刻算出に使用

### 5.4 キャンセル運用
- ユーザーキャンセルは不可
- 管理者が予約台帳でキャンセルを行う

---

## 6. 業務フロー要件

## 6.1 Web予約（一般ユーザー）
1. ユーザーが予約フォームから送信
2. 入力チェック
3. 排他制御
4. 空き枠判定
5. 予約台帳へ `CONFIRMED` で登録
6. Googleカレンダーにイベント作成
7. 台帳に `calendar_event_id` 保存
8. 管理者へ通知メール送信
9. 完了画面表示

---

## 6.2 電話予約（管理者入力）
1. 管理者が電話で予約内容を受領
2. 管理者が「電話予約登録」を実行
3. 排他制御
4. 空き枠判定（Web予約と同一ルール）
5. 予約台帳へ `CONFIRMED` で登録
6. Googleカレンダーにイベント作成
7. 台帳に `calendar_event_id` 保存
8. （任意）管理者向け通知／ログ記録

※ 電話予約も Web予約と **完全に同一の制約・判定ルール** を適用する

---

## 6.3 満枠時
- Web予約／電話予約ともに登録不可
- 別日時を案内する

---

## 6.4 管理者キャンセル
1. 管理者が台帳で対象予約を特定
2. ステータスを `CANCELED` に更新
3. 紐づくカレンダーイベントを削除（またはキャンセル表記）

---

## 7. 機能要件

### 7.1 Web予約フォーム（一般ユーザー）
#### 必須入力
- 予約メニュー
- 予約日時
- 氏名
- 電話番号

#### 任意入力
- メールアドレス
- 備考
- 車両情報

---

### 7.2 電話予約登録（管理者）
#### 入力項目（最小）
- 予約メニュー
- 予約日時
- 氏名
- 電話番号
- 備考（任意）

※ Web予約と同等の入力情報を保持する

---

### 7.3 予約台帳
#### ステータス
- `CONFIRMED`
- `CANCELED`
- `ERROR`

---

### 7.4 Googleカレンダー連携
- 予約作成時にイベント作成
- 開始：予約日時
- 終了：開始＋メニュー別所要時間
- イベントIDを台帳に保存

---

### 7.5 管理者通知
- 新規予約確定時にメール送信
- Web予約／電話予約を区別できる情報を含める（予約種別）

---

## 8. 排他制御・整合性
- Web予約／電話予約の両方で排他制御を行う
- 同時アクセス時も `capacity` を超えないこと
- 台帳とカレンダーの不整合を検知・記録できること

---

## 9. データ要件

### 9.1 予約台帳
- reservation_id
- status
- reservation_type（WEB / PHONE）
- menu
- start_at
- end_at
- name
- tel
- email
- note
- calendar_event_id
- created_at
- updated_at

---

## 10. 非機能要件

### 10.1 セキュリティ
- 管理機能へのアクセス制御
- 個人情報の閲覧範囲を限定

### 10.2 運用性
- Web予約と電話予約を区別して把握可能
- 設定値（枠数、所要時間、通知先）はシートで変更可能

---

## 11. 受入条件
- Web予約と電話予約の両方が登録できる
- 両者で空き枠判定ルールが統一されている
- `capacity` 超過の予約は作成されない
- カレンダーイベントが正しく作成・紐付けされる
- 管理者キャンセルで台帳・カレンダーが整合する
- 例外発生時にログが残る

---

## 12. 今後の検討事項
- 管理者用UI（電話予約登録）の実装方式
- 営業時間・休業日の扱い
- ERROR状態の復旧手順
- 予約者への確認メール送信有無
