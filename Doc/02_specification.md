# 仕様検討（v0.1）
GAS × スプレッドシート Web予約システム（自動車整備工場向け）

---

## 1. 全体仕様方針

### 1.1 正のデータ（Single Source of Truth）
- **予約台帳（Spreadsheet）を唯一の正**とする
- Web予約／電話予約（管理者入力）ともに、必ず予約台帳を経由して登録する
- Googleカレンダーは予約台帳の内容を反映した派生データとして扱う
- 不整合が発生した場合は、予約台帳を正として復旧する

### 1.2 予約確定タイミング
- 予約は **即時確定** とする
- 登録成功時点で `CONFIRMED` 状態とする
- `PENDING` 状態は使用しない

### 1.3 予約チャネル
- 予約経路を区別するため `reservation_type` を持つ
  - `WEB`：Web予約フォーム
  - `PHONE`：電話予約（管理者入力）
- 管理者通知メールには予約チャネルを明記する

---

## 2. 予約枠（capacity）仕様

### 2.1 枠の定義
- 予約枠は **日時固定（開始時刻）**
- `capacity` は同時刻に受付可能な台数を表す

### 2.2 枠管理方式（推奨仕様）

#### 2.2.1 テンプレート方式
- 曜日 × 時刻 × capacity のテンプレートで基本枠を定義
- 例  
  - 平日：10:00=2、13:00=2、16:00=1  
  - 土曜：10:00=1、13:00=1

#### 2.2.2 上書き（override）方式
- 日付 × 時刻 × capacity で例外を定義
- 臨時休業・祝日・増枠などを表現

#### 2.2.3 空き枠判定の優先順位
1. 日付指定の override が存在する場合はそれを使用
2. 存在しない場合は曜日テンプレートを使用
3. どちらも存在しない場合は予約不可（capacity=0）

---

## 3. メニュー仕様

### 3.1 メニュー定義
- メニューは設定シートで管理する
- 想定カラム
  - `menu_code`（例：SHAKEN / TENKEN）
  - `menu_label`（表示名）
  - `duration_minutes`（所要時間）
  - `calendar_title_prefix`

### 3.2 所要時間計算
- 予約終了時刻は以下で算出  
  `end_at = start_at + duration_minutes`

---

## 4. 予約データ仕様（予約台帳）

### 4.1 主なカラム
- `reservation_id`（UUID）
- `reservation_type`（WEB / PHONE）
- `status`（CONFIRMED / CANCELED / ERROR）
- `menu_code`
- `start_at`
- `end_at`
- `name`
- `tel`
- `email`（任意）
- `note`（任意）
- `calendar_event_id`
- `mail_sent`
- `created_at`
- `updated_at`

### 4.2 ステータス遷移
- 作成時：`CONFIRMED`
- 管理者キャンセル：`CANCELED`
- 例外発生時：`ERROR`

---

## 5. 空き枠判定仕様

### 5.1 判定ロジック
- 対象日時の予約台帳から `CONFIRMED` の件数を取得
- `件数 < capacity` の場合のみ予約可とする

### 5.2 カウント対象
- `CANCELED` はカウントしない
- `ERROR` はカウントしない（未成立扱い）

---

## 6. 予約作成処理仕様（Web／電話共通）

### 6.1 共通処理方針
- Web予約・電話予約は共通の登録処理を使用
- 差分は入力UIと `reservation_type` のみとする

### 6.2 排他制御
- GAS の `LockService` を使用
- ロック取得後に空き判定〜登録処理を行う

### 6.3 処理フロー
1. ロック取得  
2. 空き枠判定  
3. 予約台帳へ登録（CONFIRMED）  
4. Googleカレンダーイベント作成  
5. 台帳へ `calendar_event_id` を保存  
6. 管理者通知メール送信  
7. ロック解放  

---

## 7. Googleカレンダー連携仕様

### 7.1 イベント内容
- タイトル：`【メニュー】氏名（WEB/PHONE）`
- 開始：`start_at`
- 終了：`end_at`
- 説明欄：予約ID、電話番号、備考（必要最小限）

### 7.2 連携失敗時
- 予約台帳は残す
- `status=ERROR` を設定
- 管理者へエラー通知を送信する

---

## 8. 管理者通知メール仕様

### 8.1 件名
- `[WEB][予約確定] YYYY/MM/DD HH:mm メニュー 氏名`
- `[PHONE][予約確定] YYYY/MM/DD HH:mm メニュー 氏名`

### 8.2 本文
- 予約ID
- 予約種別
- 予約日時（開始〜終了）
- メニュー
- 氏名・電話番号
- 備考

### 8.3 送信失敗時
- 予約は成立扱いとする
- `mail_sent=false` を記録する

---

## 9. 管理者キャンセル仕様

### 9.1 操作方法
- 管理者が予約台帳の `status` を `CANCELED` に更新

### 9.2 キャンセル時処理
- 対応するカレンダーイベントを削除
- 失敗時は `ERROR` を記録し通知する

---

## 10. 画面仕様（最小）

### 10.1 Web予約フォーム
- 入力：メニュー、日時、氏名、電話、（任意）メール、備考
- 結果：予約ID・日時表示

### 10.2 電話予約登録（管理者）
- Web予約と同等の入力項目
- 最小UIで共通登録処理を呼び出す

---

## 11. エラー・ログ仕様

### 11.1 ログ
- GAS Logger および（必要に応じて）ログシートに記録

### 11.2 ERROR復旧
- 管理者が内容を確認し、再処理またはキャンセルを行う

---

## 12. 次工程
- スプレッドシート構成（シート一覧・列定義）
- GAS モジュール構成
- API／関数仕様定義
